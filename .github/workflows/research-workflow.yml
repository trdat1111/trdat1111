name: ğŸ¤– Auto-Fetch Tech Articles

# Random daily execution between 9am-6pm UTC
on:
  schedule:
    # Multiple cron entries to simulate random execution during business hours
    # These will trigger at different hours (9am-6pm UTC), creating randomness
    - cron: '15 9 * * *'   # 9:15 AM UTC
    - cron: '45 10 * * *'  # 10:45 AM UTC  
    - cron: '30 12 * * *'  # 12:30 PM UTC
    - cron: '20 14 * * *'  # 2:20 PM UTC
    - cron: '10 16 * * *'  # 4:10 PM UTC
    - cron: '35 18 * * *'  # 6:35 PM UTC
  
  # Manual triggers for testing
  push:
    branches: [update-readme]
  
  workflow_dispatch:
    inputs:
      data:
        description: "Optional JSON array of articles (leave empty for auto-fetch)"
        required: false
        type: string
      force_run:
        description: "Force run even if recently executed"
        required: false
        type: boolean
        default: false

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GH_TOKEN }}

jobs:
  update-articles:
    name: "Fetch & Update Articles"
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      actions: read
    
    steps:
      - name: ğŸ›¡ï¸ Check Rate Limiting
        id: rate_limit
        run: |
          # Prevent multiple runs within 4 hours (unless forced)
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "ğŸš€ Force run enabled, skipping rate limit check"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check last successful run time
          LAST_RUN=$(gh api repos/${{ github.repository }}/actions/workflows/research-workflow.yml/runs \
            --jq '.workflow_runs[] | select(.conclusion == "success") | .created_at' | head -1)
          
          if [ -z "$LAST_RUN" ]; then
            echo "ğŸ“… No previous runs found, proceeding..."
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Calculate hours since last run
          LAST_EPOCH=$(date -d "$LAST_RUN" +%s)
          CURRENT_EPOCH=$(date +%s)
          HOURS_DIFF=$(( ($CURRENT_EPOCH - $LAST_EPOCH) / 3600 ))
          
          if [ $HOURS_DIFF -ge 4 ]; then
            echo "â° Last run was ${HOURS_DIFF} hours ago, proceeding..."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "â¸ï¸ Last run was only ${HOURS_DIFF} hours ago, skipping to avoid spam"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

      - name: â­ï¸ Skip Execution
        if: steps.rate_limit.outputs.should_run == 'false'
        run: |
          echo "ğŸ”„ Execution skipped due to rate limiting"
          echo "Next eligible run: in $(( 4 - $HOURS_DIFF )) hours"
          exit 0

      - name: ğŸ“¦ Checkout Repository  
        if: steps.rate_limit.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_TOKEN }}

      - name: ğŸŸ¢ Setup Node.js
        if: steps.rate_limit.outputs.should_run == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ” Fetch Articles
        if: steps.rate_limit.outputs.should_run == 'true'
        id: fetch
        env:
          INPUT_DATA: ${{ github.event.inputs.data || '' }}
        run: |
          echo "ğŸš€ Starting article fetch process..."
          
          # Add random delay to spread out execution times
          DELAY=$((RANDOM % 1800))  # 0-30 minutes random delay
          echo "â³ Random delay: ${DELAY} seconds (to spread execution)"
          sleep $DELAY
          
          # Run the optimized script
          if [ -f "add-research-optimized.js" ]; then
            echo "ğŸ“„ Using optimized script..."
            node add-research-optimized.js
          else
            echo "ğŸ“„ Using standard script..."
            node add-research.js
          fi

      - name: ğŸ”„ Check for Changes
        if: steps.rate_limit.outputs.should_run == 'true'
        id: changes
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          if git diff --quiet README.md; then
            echo "ğŸ“ No changes detected in README.md"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ¨ Changes detected in README.md"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # Create unique branch name with timestamp
            TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
            BRANCH_NAME="auto-articles-${TIMESTAMP}"
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
            
            # Stage changes
            git add README.md
            
            # Create commit with appropriate message
            if [ "${{ github.event_name }}" = "schedule" ]; then
              COMMIT_MSG="ğŸ¤– Daily article update ($(date +'%Y-%m-%d %H:%M UTC'))"
            else
              COMMIT_MSG="ğŸ“ Manual article update"
            fi
            
            # Switch to new branch and commit
            git checkout -b $BRANCH_NAME
            git commit -m "$COMMIT_MSG"
            
            echo "ğŸ“ Created commit: $COMMIT_MSG"
          fi

      - name: ğŸš€ Push Changes
        if: steps.rate_limit.outputs.should_run == 'true' && steps.changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ steps.changes.outputs.branch_name }}
          echo "ğŸ“¤ Pushed branch: ${{ steps.changes.outputs.branch_name }}"

      - name: ğŸ”€ Create Pull Request
        if: steps.rate_limit.outputs.should_run == 'true' && steps.changes.outputs.has_changes == 'true'
        id: create_pr
        run: |
          # Dynamic PR content based on trigger
          if [ "${{ github.event_name }}" = "schedule" ]; then
            PR_TITLE="ğŸ¤– Daily Tech Articles - $(date +'%Y-%m-%d')"
            PR_BODY="## ğŸ”„ Automated Daily Update
          
          Fresh tech articles have been automatically curated and added to the profile.
          
          ### ğŸ“Š Update Details:
          - **Source**: Automated daily fetch
          - **Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')  
          - **Articles**: Latest trending tech content
          - **Sources**: Dev.to & Hacker News (rotated daily)
          
          ### ğŸ¯ Quality Filters Applied:
          - âœ… Tech relevance scoring
          - âœ… Engagement threshold filtering  
          - âœ… Duplicate detection
          - âœ… Daily source rotation for variety
          
          ---
          *ğŸ¤– Generated by automated workflow â€¢ [Claude Code](https://claude.ai/code)*"
          else
            PR_TITLE="ğŸ“ Manual Tech Articles Update"
            PR_BODY="## ğŸ”§ Manual Update
          
          Articles have been manually updated via workflow dispatch.
          
          **Triggered by**: Manual execution
          **Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          ---
          *ğŸ¤– Generated by automated workflow*"
          fi
          
          # Create the PR
          PR_URL=$(gh pr create \
            --base main \
            --head ${{ steps.changes.outputs.branch_name }} \
            --title "$PR_TITLE" \
            --body "$PR_BODY")
          
          echo "ğŸ”— Created PR: $PR_URL"
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT

      - name: âš¡ Auto-Merge (Scheduled Only)
        if: |
          steps.rate_limit.outputs.should_run == 'true' && 
          steps.changes.outputs.has_changes == 'true' && 
          github.event_name == 'schedule'
        run: |
          # Wait for PR checks to initialize
          sleep 10
          
          # Get PR number from URL
          PR_NUMBER=$(echo "${{ steps.create_pr.outputs.pr_url }}" | grep -oE '[0-9]+$')
          
          if [ -n "$PR_NUMBER" ]; then
            echo "ğŸ”„ Auto-merging PR #$PR_NUMBER..."
            
            # Auto-merge with squash
            gh pr merge $PR_NUMBER \
              --squash \
              --delete-branch \
              --admin \
              --subject "ğŸ¤– Auto-merge: Daily tech articles update"
              
            echo "âœ… Successfully auto-merged PR #$PR_NUMBER"
          else
            echo "âŒ Could not extract PR number from: ${{ steps.create_pr.outputs.pr_url }}"
            exit 1
          fi

      - name: ğŸ“Š Execution Summary
        if: always() && steps.rate_limit.outputs.should_run == 'true'
        run: |
          echo "## ğŸ“‹ Execution Summary"
          echo "- **Trigger**: ${{ github.event_name }}"
          echo "- **Time**: $(date +'%Y-%m-%d %H:%M:%S UTC')"
          echo "- **Changes**: ${{ steps.changes.outputs.has_changes || 'none' }}"
          
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "- **Branch**: ${{ steps.changes.outputs.branch_name }}"
            echo "- **PR**: ${{ steps.create_pr.outputs.pr_url }}"
            
            if [ "${{ github.event_name }}" = "schedule" ]; then
              echo "- **Status**: âœ… Auto-merged successfully"
            else
              echo "- **Status**: ğŸ“ PR created for manual review"
            fi
          else
            echo "- **Status**: ğŸ“ No new articles found"
          fi
          
          echo ""
          echo "ğŸ¯ **Next scheduled run**: Within 4-8 hours (randomized)"

      - name: â¸ï¸ Rate Limited Summary
        if: always() && steps.rate_limit.outputs.should_run == 'false'
        run: |
          echo "## â¸ï¸ Execution Skipped"
          echo "- **Reason**: Rate limiting (last run < 4 hours ago)"
          echo "- **Next run**: When rate limit expires or manual trigger"
          echo "- **Override**: Use 'force_run' input for immediate execution"