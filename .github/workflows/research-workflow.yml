name: Auto-Update README with Tech Articles

on:
    schedule:
        - cron: "0 8 * * *" # Runs daily at 8 AM UTC (3 PM Vietnam time)
    push:
        branches:
            - update-readme
    workflow_dispatch:
        inputs:
            data:
                description: "JSON string containing research data (optional - leave empty for auto-fetch)"
                required: false

jobs:
    update-readme:
        runs-on: ubuntu-latest
        permissions:
            contents: write
            pull-requests: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Run script to update README
              env:
                  INPUT_DATA: ${{ github.event.inputs.data || '' }}
              run: node add-research.js

            - name: Install GitHub CLI
              run: sudo apt-get install gh

            - name: Unset GH_TOKEN
              run: unset GH_TOKEN

            - name: Authenticate with GitHub CLI
              run: echo "${{ secrets.GH_TOKEN }}" | gh auth login --with-token
            - name: Check for changes and create branch
              id: check_changes
              run: |
                  git config --global user.name 'github-actions[bot]'
                  git config --global user.email 'github-actions[bot]@users.noreply.github.com'
                  
                  # Check if there are any changes
                  if git diff --quiet README.md; then
                      echo "No changes detected in README.md"
                      echo "changes_detected=false" >> $GITHUB_OUTPUT
                  else
                      echo "Changes detected in README.md"
                      echo "changes_detected=true" >> $GITHUB_OUTPUT
                      
                      # Create timestamp for unique branch name
                      TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
                      BRANCH_NAME="auto-research-update-$TIMESTAMP"
                      echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
                      
                      # Create and switch to new branch
                      git checkout -b $BRANCH_NAME
                      git add README.md
                      
                      # Create commit message based on trigger
                      if [ "${{ github.event_name }}" = "schedule" ]; then
                          COMMIT_MSG="ü§ñ Auto-update: Daily tech articles ($(date +'%Y-%m-%d'))"
                      else
                          COMMIT_MSG="üìù Update README with latest research"
                      fi
                      
                      git commit -m "$COMMIT_MSG"
                  fi
              
            - name: Push changes
              if: steps.check_changes.outputs.changes_detected == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  git push https://github-actions:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git ${{ steps.check_changes.outputs.branch_name }}

            - name: Create Pull Request
              if: steps.check_changes.outputs.changes_detected == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  # Create PR with dynamic content based on trigger
                  if [ "${{ github.event_name }}" = "schedule" ]; then
                      PR_TITLE="ü§ñ Daily Tech Articles Update - $(date +'%Y-%m-%d')"
                      PR_BODY="## üöÄ Automated Daily Update\n\nThis PR contains fresh tech articles automatically fetched and curated for the README.\n\n### Changes:\n- Added new trending tech articles\n- Maintained list of recent 7 articles\n- Sources: Dev.to & Hacker News\n\n**Triggered by:** Daily schedule (8 AM UTC)\n**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')\n\n---\n*This is an automated update. The articles were selected based on relevance, engagement, and trending status.*"
                  else
                      PR_TITLE="üìù Manual README Research Update"
                      PR_BODY="Manual update of README with latest research articles.\n\n---\n*This update was triggered manually via workflow dispatch.*"
                  fi
                  
                  gh pr create --base main --head ${{ steps.check_changes.outputs.branch_name }} --title "$PR_TITLE" --body "$PR_BODY"

            - name: Auto-merge Pull Request (for scheduled runs)
              if: steps.check_changes.outputs.changes_detected == 'true' && github.event_name == 'schedule'
              env:
                  GH_TOKEN: ${{ secrets.GH_TOKEN }}
              run: |
                  # Wait a moment for PR to be fully created
                  sleep 5
                  
                  PR_NUMBER=$(gh pr list --state open --head ${{ steps.check_changes.outputs.branch_name }} --json number --jq '.[0].number')
                  
                  if [ "$PR_NUMBER" != "null" ] && [ "$PR_NUMBER" != "" ]; then
                      echo "Auto-merging PR #$PR_NUMBER"
                      gh pr merge $PR_NUMBER --squash --delete-branch --admin
                      echo "‚úÖ Successfully merged and cleaned up PR #$PR_NUMBER"
                  else
                      echo "‚ùå Could not find PR to merge"
                      exit 1
                  fi
                  
            - name: Notify completion
              if: steps.check_changes.outputs.changes_detected == 'true'
              run: |
                  if [ "${{ github.event_name }}" = "schedule" ]; then
                      echo "‚úÖ Daily automation completed successfully!"
                      echo "üìä README updated with fresh tech articles"
                  else
                      echo "‚úÖ Manual update completed - PR created for review"
                  fi
                  
            - name: No changes notification
              if: steps.check_changes.outputs.changes_detected == 'false'
              run: |
                  echo "‚ÑπÔ∏è No changes detected - README already up to date"
                  echo "üîÑ Will try again tomorrow or run manually with new articles"
